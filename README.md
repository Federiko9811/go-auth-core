# Go Auth Core Pattern

A production-ready, feature-rich authentication backend template for Go (Gin), designed to be cloned and adapted for your own projects.
It implements **Passkey-first authentication** (WebAuthn), robust security practices, and a clean architecture.

## üöÄ Features

- **üîê Authentication**:
  - **WebAuthn / Passkeys**: Passwordless biometric login (TouchID, FaceID, Windows Hello, Android Biometrics).
  - **Dual Token System**: Short-lived Access Token (15 min) + Long-lived Rotating Refresh Token (7 days).
  - **Secure Cookies**: HttpOnly, SameSite=Lax/Strict, Secure (in production).

- **üõ°Ô∏è Security**:
  - **Rate Limiting**: Redis-backed sliding window limiter (DDoS protection).
  - **CORS**: Configurable trusted origins.
  - **Helmet-like Headers**: Basic security headers.

- **‚öôÔ∏è Ops & Observability**:
  - **Structured Logging**: JSON logs via Zerolog for production, pretty-printing for dev.
  - **Health Check**: Detailed status of DB and Redis.
  - **Graceful Shutdown**: Handles SIGTERM/SIGINT correcty.
  - **Docker Compose**: Ready for local development using PostgreSQL and Redis.

- **üìö Documentation**:
  - **Swagger UI**: Integrated API docs autogenerated from code comments.

---

## üõ†Ô∏è Step-by-Step Setup

### Prerequisites

- **Go** 1.21+
- **Docker** & **Docker Compose**
- **Make** (optional, for easy commands)

### 1. Clone & Rename

Clone the repository and (optionally) rename the module for your project.

```bash
git clone https://github.com/yourusername/go-auth-core.git my-app
cd my-app
```

**To rename the project (e.g., to `my-backend`):**

1. Edit `go.mod`: Change `module go-auth-core` to `module my-backend`.
2. Find & Replace all `go-auth-core` with `my-backend` in all files (VS Code: `Ctrl+Shift+H`).

### 2. Configuration

Copy the example environment file. The defaults work out-of-the-box for local development.

```bash
cp .env.example .env
```

Key variables to check in `.env`:

- `RP_ID`: Must match your domain (e.g., `localhost` for dev).
- `RP_ORIGINS`: The URL of your frontend (e.g., `http://localhost:3000`).

### 3. Start Infrastructure

Start PostgreSQL and Redis using Docker Compose.

```bash
make docker-run
# OR
docker-compose up -d
```

### 4. Run the Application

Start the Go server. It will automatically migrate the database schema.

```bash
make run
# OR
go run cmd/api/main.go
```

The server will start at `http://localhost:8080`.

---

## üíª Frontend Integration Example

This backend uses the standard WebAuthn API. While you can use the native `navigator.credentials` API, we highly recommend using **@simplewebauthn/browser** for simplifying the handling of binary data (ArrayBuffers).

### Installation

```bash
npm install @simplewebauthn/browser axios
```

### 1. Registration Flow

```javascript
import { startRegistration } from '@simplewebauthn/browser';
import axios from 'axios';

async function registerPasskey(username) {
  try {
    // 1. Get options from backend
    const resp = await axios.post('/auth/register/begin', { 
      email: username 
    });

    // 2. Pass options to browser authenticator (TouchID/FaceID)
    const attResp = await startRegistration(resp.data);

    // 3. Send verification to backend
    const verificationResp = await axios.post('/auth/register/finish', {
        email: username,
        response: attResp
    });

    if (verificationResp.status === 200) {
      alert('Registration successful! üéâ');
    }
  } catch (error) {
    console.error('Registration failed:', error);
  }
}
```

### 2. Login Flow

```javascript
import { startAuthentication } from '@simplewebauthn/browser';
import axios from 'axios';

async function loginPasskey(username) {
  try {
    // 1. Get options from backend (challenge)
    const resp = await axios.post('/auth/login/begin', { 
      email: username 
    });

    // 2. Pass options to browser authenticator
    const asseResp = await startAuthentication(resp.data);

    // 3. Send signature to backend
    const verificationResp = await axios.post('/auth/login/finish', {
        email: username,
        response: asseResp
    });

    if (verificationResp.status === 200) {
      alert('Login successful! Cookies set. üç™');
      // Redirect to dashboard...
    }
  } catch (error) {
    console.error('Login failed:', error);
  }
}
```

---

## üìù API Endpoints & Swagger

Access the full interactive documentation at:
üëâ **[http://localhost:8080/swagger/index.html](http://localhost:8080/swagger/index.html)**

### Core Endpoints

| Method | Path | Description | Access |
| :--- | :--- | :--- | :--- |
| `POST` | `/auth/register/begin` | Start Passkey registration | Public |
| `POST` | `/auth/register/finish` | Verify & Create User | Public |
| `POST` | `/auth/login/begin` | Start Passkey login | Public |
| `POST` | `/auth/login/finish` | Verify & Set Cookies | Public |
| `POST` | `/auth/refresh` | Refresh Access Token | Public (needs Refresh Cookie) |
| `POST` | `/auth/logout` | Clear Cookies | Public |
| `GET` | `/api/me` | Get User Info | **Protected** |
| `GET` | `/api/passkeys` | List User Passkeys | **Protected** |

---

## üèóÔ∏è Architecture

The project follows **Clean Architecture** principles:

- **`cmd/api`**: Entry point. Wires everything together.
- **`internal/api`**: HTTP Handlers (Controllers). Parses requests, calls Service.
- **`internal/service`**: Business Logic. Orchestrates repositories.
- **`internal/repository`**: Data Access. PostgreSQL (Gorm) & Redis.
- **`internal/domain`**: Core Data Models (Structs).
- **`pkg`**: Shared utilities (Logger, JWT, Database).

---

## üìú License

MIT License - feel free to use this for personal or commercial projects.
